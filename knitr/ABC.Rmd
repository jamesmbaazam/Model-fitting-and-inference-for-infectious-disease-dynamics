% Inference with ABC

```{r echo=FALSE,results="hide",message=FALSE}
opts_chunk$set(fig.cap='')
library(fitR)
```

The aim of this practical is to use Approximate Bayesian Computation (ABC) to circumvent the need for a tractable likelihood function when fitting your model.
To illustrate ABC, you are going to fit the [SEITL model](play_with_seitl.md) to the Tristan da Cunha epidemics. Although in this case we do have a tractable likelihood function, you may have noticed that it is computationally costly to evaluate with the particle filter for the stochastic SEITL model (i.e., it takes a long time to run), so ABC could be an attractive alternative.

There are two approximation steps at the core of ABC:

* it replaces observations with summary statistics. Unless these summary statistics are [sufficient](http://en.wikipedia.org/wiki/Sufficient_statistic), this leads to a possibly less informative posterior density.
* we are accepting simulations that are within an *acceptance window* of the data. Unless the acceptance tolerances are equal to 0, this leads to biased samples from the posterior.

On the other hand, we have seen in a previous session that MCMC provides unbiased samples from the true posterior at little cost for the deterministic SEITL model. You will end this session by fitting this deterministic model with ABC and assess the accuracy of your ABC posterior distribution by comparing it with the true posterior.

As before, you can load the stochastic SEITL model and the Tristan da Cunha data set with

```{r results="hide"}
example(SEITL_sto)
data(FluTdC1971)
```

You can plot the Tristan da Cunha data with

```{r ABC_plot_TdC_data, fig.height = 5, fig.width = 5}
plotTraj(data = FluTdC1971)
```

## Summary statistics

First of all, you need to define a set of summary statistics for the time series. Have a look at the figure above and propose at least three statistics to summarize the data. Finally, code three functions that take your time series as input and return the values of your summary statistics.


```{r eval=FALSE}

time.data <- my_SEITL$data$time
inc.data <- my_SEITL$data$Inc

# code
my_summaryStat1 <- function(time,inc){

}

# test
ss1.data <- my_summaryStat1(time=time.data,inc=inc.data)

# write other summary statistics

```

Can you check whether your summary statistics are [sufficient](http://en.wikipedia.org/wiki/Sufficient_statistic)?


## Distance between observed and simulated summary statistics

The second step is to compare your data with your simulation with distance functions between your observed and simulated summary statistics.
You can generate an observation trajectory as follows:

```{r }
theta <- c(R0 = 2, D.lat = 2, D.inf = 2, alpha = 0.9, D.imm = 13, rho = 0.85)
init.state <- c(S = 250, E = 0, I = 4, T = 0, L = 30, Inc = 0)
simu <- genObsTraj(SEITL_sto, theta, init.state, FluTdC1971$time)
head(simu)
```

And compute the set of summary statistics:

```{r eval=FALSE}
ss1.simu <- my_summaryStat1(trajectory = simu)

# compute ss2.simu etc.

```

Now, you can write a function that will take your observed and simulated summary statistics and return their distance

```{r eval=FALSE}
my_distance <- function(data, simu) {
    # compute summary statistics for data
    # compute summary statistics for simulation
    # compute a distance between the summary statistics
}
```

Test that your summary distance function returns a sensible value

```{r}
# test
dist <- my_distance(data = FluTdC1971, simu = simu)
```

## ABC acceptance function

Now you can write a function that will decide, for a given vector of tolerances, whether you should accept or reject your parameter theta.

```{r eval=FALSE}
```

ABCacceptance <- function(theta,fitmodel,tol) {

	# simulate model

	# generate observation

	# compute data and simulated summary statistics

	# compute distances between summary statistics

	# check that distances are within the tolerances

	# return 0/1

}

```

Once you have coded this function you can perform some tests to calibrate the tolerances. For instance, if your tolerances are too small you will have less biased samples but very low acceptance rate.

You can find an example of solution [here](ABC_example.md)

## Plug it into your posterior and run MCMC


## Comparison with likelihood approach


## Reference

[Review of ABC in practice](http://membres-timc.imag.fr/Michael.Blum/publications/CsilleryTREE10.pdf)


Previous: [Run SMC](smc.md)
