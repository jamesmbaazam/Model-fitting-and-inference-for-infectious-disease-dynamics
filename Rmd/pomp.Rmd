---
title: "Fitting models to data using *pomp*"
--- 

```{r setup, echo=FALSE}
knitr::opts_chunk$set(cache=TRUE, fig.path='figure/pmcmc/', cache.path='cache/pmcmc/' , fig.cap='', fig.align="center", message=FALSE, tidy=TRUE, warning=FALSE)
```

```{r fitR, echo=FALSE, cache=FALSE, results="hide"}
library(fitR)
set.seed(1234)
```
[Lecture slides](slides/pomp_slides.pdf)

# Objectives

The aim of this session is to introduce the *R* package *pomp*, which contains functions for many of the tasks we have performed in this course. The benefit of using a package like *[pomp](http://pomp.r-forge.r-project.org/)* (or alternatives such as [SSM](https://github.com/sballesteros/ssm) or [libbi](http://libbi.org/)) is that they have been optimised for computational efficiency and can take full advantage of any available hardware (including running on a high-performance cluster). The disadvantage of using readily available packages is that 1) to allow for good performance, models are usually not coded in *R* and 2) it can be more difficult to debug when something is going wrong.

The aim of this session is to see how the different methods we have encountered in the course can be applied to fit a model to data using *pomp*. 

In the [previous session](pmcmc.html), you have coded a particle filter to estimate the likelihood, and the function `mcmcMH` to sample from the posterior distribution with a Metropolis-Hastings algorithm.

In this session you will:

1. learn how to code a model in pomp using C snippets
2. explore how to use a particle filter and pMCMC using pomp
3. explore a method for real-time modelling

# Code a model in *pomp*

To do model fitting with *pomp*, you need to create a `pomp` object. This works a bit like the fitmodel objects we created earlier. To create a `pomp` object, you need to specify a data set as well as functions that simulates the model, evaluates the prior density, etc. Which components and functions exactly are needed to construct a `pomp` object depends on the method that one wants to use. For more information on this, you can have a look at the recent [article](http://pomp.r-forge.r-project.org/vignettes/pompjss.pdf) on *pomp* in the Journal of Statistical Software.

To load the `pomp` library, type
```{r}
library('pomp')
```

If this does not work, you need to install the `pomp` library. You can do this using
```{r eval = FALSE}
install.packages('pomp')
```

To specify a model that you want to fit to data in *pomp*, you can either write a function in R, or you can use so-called C snippets, that is model code written in C that is pre-compiled and can be called from an R function. The advantage of doing this is that you can benefit from the speed of compiled C code while not having to learn an awful lot about the details of C syntax.

We have coded up the models of the previous practical sessions in *pomp* for you. To look at, for example, the SEITL and SEITL2 models, use

```{r results = "hide"}
example(SEITL_pomp)
example(SEIT2L_pomp)
```

(if this yields a compile error, have a look at the [important information for windows and mac users](http://pomp.r-forge.r-project.org/vignettes/getting_started.html#important-information-for-windows-and-mac-users) or ask us for help).

__Take 10 minutes__ to have a look at the code that is printed when you execute this command, and try to understand what it does. You can have a look at our [more detailed explanation](pomp_seitl_explanation.html) for further help.

The `pomp` objects `SEITL_pomp` and `SEIT2L_pomp` now contain everything needed for model fitting and inference. Let's, again, guess some parameters and initial values:

```{r}
theta <-
    c(R0 = 2, D_lat = 2, D_inf = 2, alpha = 0.9, D_imm = 13, rho = 0.85)
SEITL.init.state <-
    c(S.0 = 250, E.0 = 0, I.0 = 4, T.0 = 0, L.0 = 30, Inc.0 = 0)
SEIT2L.init.state <-
    c(S.0 = 250, E.0 = 0, I.0 = 4, T1.0 = 0, T2.0 = 0, L.0 = 30, Inc.0 = 0)
```

Note again the *pomp* syntax, whereby initial states are named as the named variable with `.0` appended,

*Take 15-20 minutes* and try the following operations (with SEITL or SEIT2L). For full documentation of the functions used, refer to the R help pages, which you can access using `?function`.

## Deterministic trajectory

```{r}
SEITL.traj <- trajectory(SEITL_pomp,
                         params = c(theta, SEITL.init.state),
                         as.data.frame = TRUE)
plotTraj(SEITL.traj)
```

This simulates the deterministic skeleton of the `pomp` object, ignoring all process or measurement stochasticity.

## Stochastic trajectories

```{r}
SEITL.sim <- simulate(SEITL_pomp, params = c(theta, SEITL.init.state),
                      obs = TRUE, states = TRUE, 
                      as.data.frame = TRUE)
plotTraj(SEITL.sim)
```
This simulates the model of the `pomp` object.

## Trajectory matching

```{r}
tm <- traj.match(SEITL_pomp,start = c(theta, SEITL.init.state),
                 est = names(theta))
tm_sim <- simulate(tm, nsim = 10, as.data.frame = TRUE)
plotTraj(tm_sim, data = FluTdC1971)
```

This 

<div>
# Navigate
Top: [Index](index.html) Previous: [The particle MCMC](pmcmc.html)
</div>
